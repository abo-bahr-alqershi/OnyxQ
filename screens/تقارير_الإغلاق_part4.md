## مكونات طبقة التطبيق

### الكيانات (Entities)

#### ClosingReport
كيان رئيسي يمثل تقرير الإغلاق ويحتوي على:
- رقم التقرير
- نوع التقرير (شهري، ربع سنوي، سنوي)
- عنوان التقرير
- وصف التقرير
- الفترة المالية المرتبطة
- معايير التقرير
- حالة التقرير (مسودة، قيد المراجعة، معتمد)
- تاريخ الإنشاء
- تاريخ آخر تعديل
- المستخدم المنشئ
- المستخدم المعدل
- إعدادات العرض
- علاقة بالمستندات المرفقة
- علاقة بالفترة المحاسبية

#### ClosingReportTemplate
كيان يمثل قالب تقرير الإغلاق ويحتوي على:
- رقم القالب
- اسم القالب
- وصف القالب
- نوع التقرير المرتبط
- بنية التقرير
- عناصر التقرير
- معايير التقرير الافتراضية
- إعدادات العرض الافتراضية
- إمكانية المشاركة (خاص، مشترك، عام)
- تاريخ الإنشاء
- المستخدم المنشئ
- معلومات آخر تعديل

#### ClosingReportCriteria
كيان يمثل معايير تقرير الإغلاق ويحتوي على:
- رقم المعيار
- اسم مجموعة المعايير
- الفترة المالية
- نطاق التاريخ
- الفروع المحددة
- العملات المحددة
- مستوى التفصيل
- معايير المقارنة
- معايير التصفية
- معايير الفرز
- معايير التجميع
- علاقة بتقرير الإغلاق

#### ClosingReportData
كيان يمثل بيانات تقرير الإغلاق ويحتوي على:
- رقم البيانات
- رقم التقرير المرتبط
- البيانات المالية
- البيانات المحسوبة
- البيانات التحليلية
- البيانات المقارنة
- تاريخ توليد البيانات
- حالة البيانات (محدثة، قديمة)
- نسخة البيانات
- علاقة بمصادر البيانات

#### ClosingReportSection
كيان يمثل قسم من أقسام تقرير الإغلاق ويحتوي على:
- رقم القسم
- رقم التقرير المرتبط
- عنوان القسم
- نوع القسم (جدول، رسم بياني، نص)
- ترتيب القسم
- إعدادات عرض القسم
- البيانات المرتبطة بالقسم
- الملاحظات على القسم
- حالة العرض (ظاهر، مخفي)

#### ClosingReportNote
كيان يمثل ملاحظة على تقرير الإغلاق ويحتوي على:
- رقم الملاحظة
- رقم التقرير المرتبط
- نص الملاحظة
- نوع الملاحظة (عامة، خاصة ببند)
- أولوية الملاحظة
- حالة الملاحظة (جديدة، قيد المعالجة، منتهية)
- المستخدم المنشئ
- تاريخ الإنشاء
- تاريخ آخر تحديث
- علاقة ببند التقرير (إن وجد)

#### ClosingReportAttachment
كيان يمثل مرفق بتقرير الإغلاق ويحتوي على:
- رقم المرفق
- رقم التقرير المرتبط
- اسم الملف
- نوع الملف
- حجم الملف
- وصف المرفق
- تاريخ الإرفاق
- المستخدم المرفق
- رابط الملف
- نوع المرفق (مستند داعم، ملف تحليلي، غيره)

#### ClosingReportSchedule
كيان يمثل جدولة تقرير الإغلاق ويحتوي على:
- رقم الجدولة
- رقم التقرير المرتبط
- نمط التكرار
- تاريخ البدء
- تاريخ الانتهاء (اختياري)
- آخر تنفيذ
- التنفيذ القادم
- قائمة المستلمين
- إعدادات التسليم
- حالة الجدولة (نشطة، متوقفة)
- تاريخ آخر تعديل
- المستخدم المعدل

#### ClosingReportApproval
كيان يمثل اعتماد تقرير الإغلاق ويحتوي على:
- رقم الاعتماد
- رقم التقرير المرتبط
- نوع الاعتماد (إعداد، مراجعة، اعتماد نهائي)
- حالة الاعتماد (منتظر، معتمد، مرفوض)
- المستخدم المسؤول
- تاريخ الاعتماد
- ملاحظات الاعتماد
- رقم الإصدار المعتمد
- توقيع المستخدم

### الأوامر (Commands)

#### CreateClosingReportCommand
إنشاء تقرير إغلاق جديد في النظام.

**منطق الأعمال والتحققات**:
- التحقق من صلاحية المستخدم لإنشاء تقارير الإغلاق
- التحقق من توفر جميع البيانات المطلوبة
- التحقق من صحة الفترة المالية المحددة
- إنشاء كيان تقرير جديد وتعيين الحالة الابتدائية
- تطبيق القالب المحدد إن وجد
- تخزين معايير التقرير
- توليد رقم فريد للتقرير
- تسجيل معلومات الإنشاء (المستخدم، التاريخ)

#### UpdateClosingReportCommand
تحديث تقرير إغلاق موجود.

**منطق الأعمال والتحققات**:
- التحقق من صلاحية المستخدم لتعديل التقرير
- التحقق من وجود التقرير وحالته (لا يمكن تعديل التقارير المعتمدة نهائيًا)
- تحديث المعلومات والمعايير المطلوبة
- الحفاظ على تاريخ التغييرات في سجل المراجعة
- تحديث حالة التقرير إذا لزم الأمر
- تسجيل معلومات التعديل (المستخدم، التاريخ)

#### GenerateClosingReportDataCommand
توليد بيانات تقرير الإغلاق.

**منطق الأعمال والتحققات**:
- التحقق من صلاحية المستخدم للوصول للبيانات
- التحقق من وجود جميع مصادر البيانات المطلوبة
- استخراج البيانات المالية بناءً على معايير التقرير
- تنفيذ العمليات الحسابية والتحليلية اللازمة
- تطبيق تحويلات العملات إذا لزم الأمر
- تجميع وتنظيم البيانات حسب هيكل التقرير
- تخزين البيانات المولدة مع الإصدار والتاريخ
- تحديث حالة البيانات لتكون محدثة

#### SaveClosingReportTemplateCommand
حفظ قالب تقرير إغلاق.

**منطق الأعمال والتحققات**:
- التحقق من صلاحية المستخدم لإنشاء/تعديل القوالب
- التحقق من صحة بنية القالب
- التحقق من فرادة اسم القالب
- حفظ إعدادات وبنية القالب
- تحديد خيارات المشاركة والصلاحيات
- تسجيل معلومات الإنشاء/التعديل

#### ScheduleClosingReportCommand
جدولة إنشاء وتوزيع تقرير إغلاق.

**منطق الأعمال والتحققات**:
- التحقق من صلاحية المستخدم لجدولة التقارير
- التحقق من صحة نمط التكرار والتواريخ
- التحقق من وجود قائمة مستلمين صالحة
- إنشاء كيان جدولة جديد مرتبط بالتقرير
- حساب توقيت التنفيذ القادم
- تكوين إعدادات التسليم والإشعارات
- تفعيل حالة الجدولة

#### ExportClosingReportCommand
تصدير تقرير إغلاق بتنسيق محدد.

**منطق الأعمال والتحققات**:
- التحقق من صلاحية المستخدم لتصدير التقارير
- التحقق من توفر البيانات اللازمة للتصدير
- التحقق من صحة تنسيق التصدير المطلوب
- تحويل بيانات التقرير إلى التنسيق المطلوب
- تطبيق قواعد التنسيق والتصميم
- إنشاء ملف التصدير (PDF، Excel، CSV، إلخ)
- تسجيل عملية التصدير في سجل الأنشطة

#### AddClosingReportNoteCommand
إضافة ملاحظة لتقرير إغلاق.

**منطق الأعمال والتحققات**:
- التحقق من صلاحية المستخدم لإضافة ملاحظات
- التحقق من وجود التقرير وإمكانية إضافة ملاحظات عليه
- إنشاء كيان ملاحظة جديد
- ربط الملاحظة بالتقرير أو ببند محدد فيه
- تعيين حالة الملاحظة الابتدائية
- إشعار المستخدمين المعنيين بإضافة الملاحظة
- تسجيل معلومات إنشاء الملاحظة

#### ApproveClosingReportCommand
اعتماد تقرير إغلاق.

**منطق الأعمال والتحققات**:
- التحقق من صلاحية المستخدم لاعتماد التقارير
- التحقق من وجود التقرير وحالته الحالية
- التحقق من اكتمال جميع المراجعات المطلوبة
- إنشاء كيان اعتماد جديد مرتبط بالتقرير
- تحديث حالة التقرير بناءً على نوع الاعتماد
- تسجيل توقيع المستخدم وتاريخ الاعتماد
- إشعار المستخدمين المعنيين بعملية الاعتماد 